<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TiffyAI — Wallet Connect</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #0b0b0b;
    color: white;
    text-align: center;
    padding: 30px;
  }
  #connectBtn {
    padding: 12px 22px;
    background: #ff0080;
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-size: 18px;
  }
  #connectBtn:disabled {
    opacity: 0.6;
  }
  .info {
    margin-top: 20px;
    font-size: 16px;
  }
</style>

<!-- Web3 -->
<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>

</head>
<body>

<h2>TiffyAI — DApp Loader</h2>
<button id="connectBtn">Connect Wallet</button>

<div class="info">
  <div id="addrDisplay">Not connected</div>
  <small id="statusSmall"></small>
</div>

<script>
/* CONFIG */
const CONNECT_CONFIG = {
  wcProjectId: 'bf40c7dcdb05f06f2769573103007576', // YOUR PROJECT ID ✔
  rpc: { 56: 'https://bsc-dataseed.binance.org/' },
  chainId: 56,
  chainHex: '0x38',
  chainNamespaceId: 'eip155:56'
};

let provider = null;
let web3 = null;
let userAddress = null;

const connectBtn = document.getElementById('connectBtn');
const addrDisplay = document.getElementById('addrDisplay');
const statusSmall = document.getElementById('statusSmall');

/* MAIN CONNECT FUNCTION */
async function connectWallet() {

  /* 1) METAMASK / INJECTED */
  if (window.ethereum && window.ethereum.isMetaMask) {
    try {
      await window.ethereum.request({ method: 'eth_requestAccounts' });
      provider = window.ethereum;
      web3 = new Web3(provider);
      const accounts = await web3.eth.getAccounts();
      userAddress = accounts[0];
      onConnected('MetaMask / Injected');
      return;
    } catch (e) {
      console.warn('MetaMask failed, trying WC2');
    }
  }

  /* 2) WalletConnect v2 (Reown) */
  try {
    if (!window.SignClient) {
      await loadScript("https://unpkg.com/@walletconnect/sign-client/dist/sign-client.min.js");
    }

    const SignClient = window.SignClient;
    const client = await SignClient.init({
      projectId: CONNECT_CONFIG.wcProjectId,
      metadata: {
        name: "TiffyAI Connector",
        description: "WalletConnect v2 DApp Loader",
        url: "https://tiffyai.github.io",
        icons: ["https://tiffyai.github.io/Dream-Menu/TiffyAI-Token.png"]
      }
    });

    const requiredNamespaces = {
      eip155: {
        methods: ["eth_chainId", "eth_accounts", "personal_sign", "eth_sign"],
        chains: [CONNECT_CONFIG.chainNamespaceId],
        events: ["accountsChanged", "chainChanged"]
      }
    };

    const { uri, approval } = await client.connect({ requiredNamespaces });

    if (uri) {
      const encoded = encodeURIComponent(uri);
      openDeepLink(`trust://wc?uri=${encoded}`);
      setTimeout(() => openDeepLink(uri), 800);
    }

    const session = await approval();
    const accounts = extractAccountsFromSession(session);
    userAddress = accounts[0];

    provider = createWCv2ProviderWrapper(client, session);
    web3 = new Web3(provider);

    onConnected("WalletConnect v2 (Reown)");
    return;

  } catch (err) {
    console.warn("WC v2 failed:", err);
  }

  /* 3) WALLETCONNECT v1 FALLBACK */
  try {
    if (!window.WalletConnectProvider_v1) {
      await loadScript("https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js");
      window.WalletConnectProvider_v1 = window.WalletConnectProvider;
    }

    const WCProvider = window.WalletConnectProvider_v1;
    const wcProv = new WCProvider({
      rpc: CONNECT_CONFIG.rpc,
      chainId: CONNECT_CONFIG.chainId,
      qrcode: true
    });

    await wcProv.enable();
    provider = wcProv;
    web3 = new Web3(provider);
    const accounts = await web3.eth.getAccounts();
    userAddress = accounts[0];

    onConnected("WalletConnect v1 Fallback");
    return;

  } catch (err) {
    console.warn("WC v1 failed:", err);
  }

  alert("No wallet detected.");
}

/* UI UPDATES */
function onConnected(type) {
  addrDisplay.textContent = "Connected: " + userAddress.slice(0, 6) + "..." + userAddress.slice(-4);
  statusSmall.textContent = type;
  connectBtn.textContent = "Connected";
}

/* DEEP LINK HELPER */
function openDeepLink(url) {
  try { window.location.href = url; } catch (e) {}
}

/* LOAD SCRIPT HELPER */
function loadScript(src) {
  return new Promise((res, rej) => {
    const s = document.createElement("script");
    s.src = src;
    s.onload = res;
    s.onerror = rej;
    document.head.appendChild(s);
  });
}

/* EXTRACT ACCOUNTS WC2 */
function extractAccountsFromSession(session) {
  const out = [];
  const ns = session.namespaces || {};
  for (const key of Object.keys(ns)) {
    for (const acc of ns[key].accounts || []) {
      out.push(acc.split(":")[2]);
    }
  }
  return out;
}

/* WC2 PROVIDER WRAPPER */
function createWCv2ProviderWrapper(client, session) {
  const topic = session.topic;
  return {
    request: async ({ method, params }) => {
      return client.request({
        topic,
        chainId: CONNECT_CONFIG.chainNamespaceId,
        request: { method, params }
      });
    }
  };
}

/* BUTTON */
connectBtn.addEventListener("click", async () => {
  connectBtn.disabled = true;
  connectBtn.textContent = "Connecting...";
  await connectWallet();
  if (!userAddress) connectBtn.textContent = "Connect Wallet";
  connectBtn.disabled = false;
});
</script>

</body>
</html>
