<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TiffyAI Presale — $1 = 1,000,000 TIFFY</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <style>
    :root {
      --neon: #00f0ff;
      --pink: #ff00d4;
      --dark: #0a0a0a;
      --glass: rgba(10,10,10,0.7);
      --border: rgba(0,240,255,0.3);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: #000 url('Presale1.jpg') center/cover fixed;
      color: var(--neon);
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      overflow-x: hidden;
    }
    .container {
      max-width: 800px;
      width: 100%;
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 16completedpx;
      padding: 24px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      margin-top: 40px;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .header h1 {
      font-size: 2.5rem;
      background: linear-gradient(135deg, var(--neon), var(--pink));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .wallet-btn {
      background: linear-gradient(135deg, var(--neon), var(--pink));
      color: #000;
      border: none;
      padding: 14px 28px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      margin: 10px;
      box-shadow: 0 4px 15px rgba(0,240,255,0.3);
    }
    .wallet-btn:hover { transform: scale(1.05); }
    .amount-input {
      width: 100%;
      padding: 16px;
      margin: 16px 0;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
      color: white;
      font-size: 1.2rem;
      text-align: center;
    }
    .total {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 700;
      margin: 16px 0;
      color: var(--neon);
    }
    .invoice {
      background: rgba(0,0,0,0.4);
      border-radius: 12px;
      padding: 16px;
      margin-top: 20px;
      text-align: center;
      display: none;
    }
    .addr {
      font-family: monospace;
      font-size: 1.1rem;
      word-break: break-all;
      background: rgba(0,0,0,0.3);
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
    }
    .copy-btn {
      background: rgba(255,255,255,0.1);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
    }
    .status {
      margin-top: 10px;
      font-size: 0.9rem;
      opacity: 0.8;
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="header">
      <h1>TiffyAI Presale</h1>
      <p>$1 = 1,000,000 TIFFY • Limited Time</p>
    </div>

    <div style="text-align:center;">
      <button class="wallet-btn" onclick="connect('metamask')">MetaMask</button>
      <button class="wallet-btn" onclick="connect('okx')">OKX Wallet</button>
      <button class="wallet-btn" onclick="connect('trust')">Trust Wallet</button>
    </div>

    <input type="number" id="usdAmount" class="amount-input" placeholder="Enter USD amount (min $1)" min="1" value="1" />

    <div class="total" id="totalDisplay">Total: 0.001 BNB</div>

    <div id="walletStatus" class="status">Not connected</div>

    <div id="invoice" class="invoice">
      <h3>Send BNB to:</h3>
      <div class="addr" id="payAddress">—</div>
      <button class="copy-btn" onclick="copy('payAddress')">Copy Address</button>
      <button class="copy-btn" onclick="copyAmount()">Copy Amount</button>
      <div class="status" id="invoiceStatus">Waiting for payment...</div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://tiffyai-wh-wa.onrender.com';
    let walletAddress = null;
    let invoiceId = null;

    function updateTotal() {
      const usd = parseFloat(document.getElementById('usdAmount').value) || 1;
      const bnb = (usd / 1000).toFixed(6); // $1 = 0.001 BNB
      document.getElementById('totalDisplay').innerText = `Total: ${bnb} BNB`;
    }
    document.getElementById('usdAmount').addEventListener('input', updateTotal);
    updateTotal();

    async function connect(type) {
      let provider;
      if (type === 'metamask' && window.ethereum?.isMetaMask) provider = window.ethereum;
      else if (type === 'okx' && window.okxwallet) provider = window.okxwallet;
      else if (type === 'trust' && window.trustwallet) provider = window.trustwallet;
      else {
        alert('Wallet not detected');
        return;
      }

      try {
        const accounts = await provider.request({ method: 'eth_requestAccounts' });
        walletAddress = accounts[0];

        // Switch to BSC
        await provider.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: '0x38' }]
        });

        document.getElementById('walletStatus').innerText = 
          `Connected: \( {walletAddress.slice(0,6)}... \){walletAddress.slice(-4)}`;

        createInvoice();
      } catch (e) {
        alert('Connection failed: ' + e.message);
      }
    }

    async function createInvoice() {
      const usd = parseFloat(document.getElementById('usdAmount').value) || 1;
      const bnb = (usd / 1000).toFixed(6);

      try {
        const resp = await fetch(`${API_BASE}/create-invoice`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            wallet: walletAddress,
            currency: 'BNB',
            qty: usd * 1000000, // 1M TIFFY per $
            amount: bnb
          })
        });

        const data = await resp.json();
        if (!resp.ok) throw new Error(data.message || 'Failed');

        invoiceId = data.invoiceId;
        document.getElementById('payAddress').innerText = data.payToAddress;
        document.getElementById('invoice').style.display = 'block';
        document.getElementById('invoiceStatus').innerText = 'Send exactly ' + bnb + ' BNB';

        pollStatus();
      } catch (e) {
        alert('Invoice failed: ' + e.message);
      }
    }

    function copy(id) {
      const text = document.getElementById(id).innerText;
      navigator.clipboard.writeText(text);
      alert('Copied!');
    }

    function copyAmount() {
      const bnb = (parseFloat(document.getElementById('usdAmount').value) / 1000).toFixed(6);
      navigator.clipboard.writeText(bnb);
      alert('Copied: ' + bnb + ' BNB');
    }

    async function pollStatus() {
      if (!invoiceId) return;
      const interval = setInterval(async () => {
        try {
          const resp = await fetch(`\( {API_BASE}/invoice/ \){invoiceId}`);
          const data = await resp.json();
          if (data.status === 'paid') {
            document.getElementById('invoiceStatus').innerText = 'Payment received!';
            setTimeout(() => {
              alert('Payment confirmed! Redirecting...');
              window.location.href = '/Blue-Key-Claim';
            }, 1000);
            clearInterval(interval);
          } else if (data.status === 'rewarded') {
            window.location.href = '/Blue-Key-Claim';
          }
        } catch (e) {
          console.log('Polling...');
        }
      }, 5000);
    }
  </script>
</body>
</html>
