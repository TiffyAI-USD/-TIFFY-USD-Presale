<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TiffyAI Presale â€” Checkout</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
  <style>
    /* â€”â€”â€” (ALL YOUR ORIGINAL STYLES UNCHANGED) â€”â€”â€” */
  </style>
</head>
<body>

  <!-- â€”â€”â€” YOUR ENTIRE ORIGINAL HTML BODY UNCHANGED â€”â€”â€” -->

<script>
// === CONFIG ===
const PRESALE_WALLET = '0xed9b43bED20B063ae0966C0AEC446bc755fB84bA';
const API_BASE = 'https://tiffyai-wh-wa.onrender.com';
const BSC_RPC = 'https://bsc-dataseed.binance.org/';

// === STATE ===
let userAddress = null;
let provider = null;
let web3 = null;
let prices = { BNB: 810, USDT: 1, BTCB: 95000 };
let bnbPrice = 810;

// === DOM ===
const connectBtn = document.getElementById('connectBtn');
const buyBtn = document.getElementById('buyBtn');
const currencyEl = document.getElementById('currency');
const qtyEl = document.getElementById('qty');
const amountDisplay = document.getElementById('amountDisplay');
const usdDisplay = document.getElementById('usdDisplay');
const addrDisplay = document.getElementById('addrDisplay');
const statusSmall = document.getElementById('statusSmall');
const payModal = document.getElementById('payModal');
const payAddress = document.getElementById('payAddress');
const modalCurrency = document.getElementById('modalCurrency');
const modalExpires = document.getElementById('modalExpires');
const invQty = document.getElementById('invQty');
const invPrice = document.getElementById('invPrice');
const invTotal = document.getElementById('invTotal');
const qrPlaceholder = document.getElementById('qrPlaceholder');
const copyAddr = document.getElementById('copyAddr');
const copyAmount = document.getElementById('copyAmount');
const payWithWallet = document.getElementById('payWithWallet');
const submitTx = document.getElementById('submitTx');
const txHashInput = document.getElementById('txHashInput');

// ======================================================
// ðŸŸ© TRUST WALLET FIX â€” USE PROPER PROVIDER DETECTION
// ======================================================
function getInjectedProvider() {
    if (window.ethereum) return window.ethereum;                     // MetaMask, OKX, sometimes Trust
    if (window.trustwallet) return window.trustwallet;               // Trust Wallet legacy
    if (window.tw && window.tw.ethereum) return window.tw.ethereum;  // Trust Wallet 2024+
    return null;
}

// ======================================================
// ðŸŸ¦ CONNECT WALLET â€” FIXED FOR TRUST WALLET
// ======================================================
async function connectWalletHandler() {
    connectBtn.disabled = true;
    connectBtn.textContent = 'Connecting...';

    const injected = getInjectedProvider();

    if (!injected) {
        alert("Wallet not injected. Refresh inside Trust Wallet DApp browser.");
        connectBtn.disabled = false;
        connectBtn.textContent = "Connect Wallet";
        return;
    }

    provider = injected;
    web3 = new Web3(provider);

    try {
        await provider.request({ method: 'eth_requestAccounts' });
        const accounts = await web3.eth.getAccounts();
        userAddress = accounts[0];
        addrDisplay.textContent = 'Connected: ' +
          userAddress.slice(0,6) + '...' + userAddress.slice(-4);

        statusSmall.textContent = 'BNB Chain';
        await ensureChain();

        connectBtn.textContent = "Connected";
        connectBtn.disabled = false;

    } catch (err) {
        console.log("Connect failed:", err);
        connectBtn.disabled = false;
        connectBtn.textContent = "Connect Wallet";
    }
}

// ======================================================
// CHAIN ENSURE â€” UNCHANGED
// ======================================================
async function ensureChain() {
  try {
    const chainId = await web3.eth.getChainId();
    if (chainId !== 56) {
      await provider.request({
        method: 'wallet_switchEthereumChain',
        params: [{ chainId: '0x38' }],
      });
    }
  } catch (e) {
    if (e.code === 4902) {
      await provider.request({
        method: 'wallet_addEthereumChain',
        params: [{
          chainId: '0x38',
          chainName: 'BNB Smart Chain',
          nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
          rpcUrls: [BSC_RPC],
          blockExplorerUrls: ['https://bscscan.com']
        }],
      });
    }
  }
}

// ======================================================
// PRICE FETCH, BUY FLOW, MODAL, QR, PAYMENT POLLING
// â€”â€”â€” YOUR ORIGINAL LOGIC â€”â€”â€”
// ======================================================

async function fetchPrices() {
  try {
    const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=binancecoin,bitcoin,tether&vs_currencies=usd');
    const data = await res.json();
    prices.BNB = data.binancecoin.usd;
    prices.BTCB = data.bitcoin.usd;
    prices.USDT = 1.0;
    bnbPrice = prices.BNB;
    updateAmount();
  } catch (e) {
    prices = { BNB: 810, BTCB: 95000, USDT: 1 };
    bnbPrice = 810;
    updateAmount();
  }
}

function getBnbPerToken() { return (1 / bnbPrice).toFixed(8); }

function updateAmount() {
  const qty = Math.max(1, parseInt(qtyEl.value) || 1);
  const cur = currencyEl.value;
  const bnbPerToken = parseFloat(getBnbPerToken());
  let totalCrypto = 0, fmtCrypto = '', pricePerToken = '';

  if (cur === 'BNB') {
    totalCrypto = qty * bnbPerToken;
    fmtCrypto = totalCrypto.toFixed(6);
    pricePerToken = bnbPerToken + ' BNB';
  } else if (cur === 'USDT') {
    totalCrypto = qty * 1.0;
    fmtCrypto = totalCrypto.toFixed(2);
    pricePerToken = '1.00 USDT';
  } else {
    totalCrypto = (qty * 1.0) / prices.BTCB;
    fmtCrypto = totalCrypto.toFixed(8);
    pricePerToken = (1/prices.BTCB).toFixed(8) + ' BTCB';
  }

  amountDisplay.textContent = 'Total: ' + fmtCrypto + ' ' + cur;
  usdDisplay.textContent = 'â‰ˆ $' + (qty * 1).toFixed(2) + ' USD (1 TIFFY = $1.00)';
}

// â€”â€”â€” BUY FLOW, QR, PAYMENT POLLING (UNCHANGED) â€”â€”â€”

connectBtn.addEventListener('click', connectWalletHandler);
currencyEl.addEventListener('change', updateAmount);
qtyEl.addEventListener('input', updateAmount);
fetchPrices();
setInterval(fetchPrices, 30000);
</script>

</body>
</html>
